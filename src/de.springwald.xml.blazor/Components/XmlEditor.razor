@using de.springwald.xml.blazor
@using Blazor.Extensions
@using Blazor.Extensions.Canvas
@using de.springwald.xml.blazor.NativePlatform
@using editor.nativeplatform.gfx
@using de.springwald.xml.editor
@inject IJSRuntime JSRuntime
@implements IDisposable


<div class="card">
    <div class="card-body">
        <div tabindex="0"  
             @onmousedown="EventOnMouseDown" @onmousemove="EventOnMouseMove" @onmouseup="EventOnMouseUp"  
             @onkeypress="EventOnKeyPress" @onkeydown="EventOnKeyDown" 
             @ref="_canvasDivReference">
            <BECanvas Width="700" Height="500" @ref="_canvasReference">
            </BECanvas>
        </div>
    </div>
</div>

@code {

    private bool initDone;
    private XmlEditorContext _editorContext;
    public de.springwald.xml.editor.XMLEditor Editor;
    protected BECanvasComponent _canvasReference;
    protected ElementReference _canvasDivReference;
    protected BlazorNativePlatform nativePlattform;

    [Parameter]
    public XmlEditorContext EditorContext
    {
        set
        {
            this._editorContext = value;
            if (value != null && this.nativePlattform != null) this.Init();
        }
        get
        {
            return this._editorContext;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            this.nativePlattform = new BlazorNativePlatform(_canvasReference);
            await this.nativePlattform.SetSize(700, 500-10);
            if (this.EditorContext != null) this.Init();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private void Init()
    {
        if (this.initDone) return;
        this.initDone = true;

        var config = new EditorConfig
        {
            NodeNameFont = new Font(names: new [] { "Verdana", "Geneva", "sans-serif" }, height: 13, graphicsUnit: Font.GraphicsUnit.Pixel, monospace: false),
            NodeAttributeFont = new Font(names: new[] { "Verdana", "Geneva", "sans-serif" }, height: 12, graphicsUnit: Font.GraphicsUnit.Pixel, monospace: false),
            TextNodeFont = new Font(names: new[] { "Lucida Console", "Monaco", "monospace" }, height: 14, graphicsUnit: Font.GraphicsUnit.Pixel, monospace: true)
        };

        this.Editor = new XMLEditor(this._editorContext.XmlRules, nativePlattform, config);

        this._editorContext.RootNodeChanged.Add(this.RootNodeChanged);
    }

    public void Dispose()
    {
        this._editorContext?.RootNodeChanged.Remove(this.RootNodeChanged);
    }

    private async Task RootNodeChanged(System.Xml.XmlNode rootNode)
    {
        await this.Editor.SetRootNode(rootNode);
        //await this.xmlEditor.Paint(new de.springwald.xml.events.PaintEventArgs() { Graphics = nativePlattform.Gfx });
    }

    public class BoundingClientRect
    {
        public double X { get; set; }
        public double Y { get; set; }
        public double Width { get; set; }
        public double Height { get; set; }
        public double Top { get; set; }
        public double Right { get; set; }
        public double Bottom { get; set; }
        public double Left { get; set; }
    }

    //async void EventOnClick(MouseEventArgs e)
    //{
    //    var result = await JSRuntime.InvokeAsync<BoundingClientRect>("MyDOMGetBoundingClientRect", new object[] { this._canvasDivReference });

    //    var x = (int)(e.ClientX - result.Left);
    //    var y = (int)(e.ClientY - result.Top);

    //    await this.nativePlattform.InputEvents.MouseDown.Trigger(new de.springwald.xml.events.MouseEventArgs
    //    {
    //        X = x,
    //        Y = y
    //    });
    //}


    public async void EventOnKeyPress(KeyboardEventArgs e)
    {
        // await this.KeyPress.Trigger(new KeyEventArgs { Key = e.Key });
    }

    public async void EventOnKeyDown(KeyboardEventArgs e)
    {
        await this.nativePlattform.InputEvents.PreviewKey.Trigger(new de.springwald.xml.events.KeyEventArgs { Key = de.springwald.xml.events.Keys.A });
    }


    async void EventOnMouseDown(MouseEventArgs e)
    {
        var result = await JSRuntime.InvokeAsync<BoundingClientRect>("MyDOMGetBoundingClientRect", new object[] { this._canvasDivReference });

        var x = (int)(e.ClientX - result.Left);
        var y = (int)(e.ClientY - result.Top);

        await this.nativePlattform.InputEvents.MouseDown.Trigger(new de.springwald.xml.events.MouseEventArgs
        {
            X = x,
            Y = y
        });
    }

    async void EventOnMouseMove(MouseEventArgs e)
    {
        var result = await JSRuntime.InvokeAsync<BoundingClientRect>("MyDOMGetBoundingClientRect", new object[] { this._canvasDivReference });

        var x = (int)(e.ClientX - result.Left);
        var y = (int)(e.ClientY - result.Top);

        await this.nativePlattform.InputEvents.MouseMove.Trigger(new de.springwald.xml.events.MouseEventArgs
        {
            X = x,
            Y = y
        });
    }

    async void EventOnMouseUp(MouseEventArgs e)
    {
        var result = await JSRuntime.InvokeAsync<BoundingClientRect>("MyDOMGetBoundingClientRect", new object[] { this._canvasDivReference });

        var x = (int)(e.ClientX - result.Left);
        var y = (int)(e.ClientY - result.Top);

        await this.nativePlattform.InputEvents.MouseUp.Trigger(new de.springwald.xml.events.MouseEventArgs
        {
            X = x,
            Y = y
        });
    }
}
